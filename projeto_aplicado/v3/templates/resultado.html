{% extends 'base.html' %}
{% block conteudo %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .tbl-result th, .tbl-result td { font-size:12px; vertical-align:middle; }
  .cell-prof, .cell-disc { line-height:1.2; }
  .cell-prof .id { display:block; font-size:10px; color:#666; }
  .cell-disc .codigo { display:block; font-size:10px; color:#666; }
  .pref-sphere { width:14px; height:14px; border-radius:50%; display:inline-block; }
  .pref-sphere.p3 { background:#2e8b57; }
  .pref-sphere.p2 { background:#ffd54f; }
  .pref-sphere.p1 { background:#ff9800; }
  .pref-sphere.p0 { background:#f44336; }
  .pref-sphere.fixada { background:#6a0dad; box-shadow:0 0 0 2px #eee; }
  .badge-export { display:inline-flex; align-items:center; gap:6px; }
  .table-hover tbody tr:hover { background:#f5f9ff; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h5 mb-0">Resultado da Otimização</h2>
  <a href="/resultado/export" class="btn btn-outline-primary btn-sm badge-export" title="Baixar Excel">
    <span style="width:14px;height:14px;display:inline-block;border:2px solid #0d6efd;border-radius:4px"></span> Exportar Excel
  </a>
</div>

{% if resumo %}
<div class="row g-2 mb-3">
  <div class="col-auto">
    <span class="badge bg-secondary">Escore: {{ resumo.escore_total if resumo.escore_total is not none else 'N/D' }}</span>
  </div>
  <div class="col-auto d-flex align-items-center gap-1">
    <span class="pref-sphere p3" title="Preferência 3"></span><span class="small">{{ resumo.pref_3 }}</span>
    <span class="pref-sphere p2" title="Preferência 2"></span><span class="small">{{ resumo.pref_2 }}</span>
    <span class="pref-sphere p1" title="Preferência 1"></span><span class="small">{{ resumo.pref_1 }}</span>
    <span class="pref-sphere p0" title="Preferência 0"></span><span class="small">{{ resumo.pref_0 }}</span>
    <span class="pref-sphere fixada" title="Alocações Fixadas"></span><span class="small">{{ resumo.fixadas }}</span>
  </div>
  <div class="col-auto">
    <span class="badge bg-light text-dark">Total: {{ resumo.total }}</span>
  </div>
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle tbl-result">
    <thead class="table-dark">
      <tr>
        <th>Professor</th>
        <th>Disciplina</th>
        <th class="text-center">Pref.</th>
        <th class="text-center">Cód. Horário</th>
        <th class="text-center">Cód. Turma</th>
        <th class="text-center">CH</th>
        <th class="text-center">Nível</th>
      </tr>
    </thead>
    <tbody>
    {% for r in registros %}
      {% set nome_prof = r.nome_docente or r.docente or r.nome or '' %}
      {% set nome_disc = r.nome_disciplina or r.disciplina or '' %}
      {% set pref_val = r.preferencia %}
      {% set nivel_cls = ( 'fixada' if r.fixada else ('p' ~ (pref_val if pref_val in [0,1,2,3] else 0)) ) %}
      <tr>
        <td class="cell-prof">
          <strong>{{ nome_prof }}</strong>
          <span class="id">{{ r.id_docente }}</span>
        </td>
        <td class="cell-disc">
          <strong>{{ nome_disc }}</strong>
          <span class="codigo">{{ r.id_disciplina }}</span>
        </td>
        <td class="text-center"><span class="fw-semibold">{{ pref_val }}</span></td>
        <td class="text-center">{{ r.horario or '-' }}</td>
        <td class="text-center">{{ r.codigo_turma }}</td>
        <td class="text-center">{{ r.ch_disciplina }}</td>
        <td class="text-center"><span class="pref-sphere {{ nivel_cls }}" title="{% if r.fixada %}Alocação Fixada{% else %}Preferência {{ pref_val }}{% endif %}"></span></td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}